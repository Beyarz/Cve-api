# frozen_string_literal: true

require 'erb'
require 'json'
require_relative 'general.rb'
require_relative 'configuration.rb'
require_relative 'scan.rb'

begin
  require 'sinatra'
  require 'sanitize'
  require 'dotenv/load'
rescue LoadError
  import_failure
end

# Note: https://gist.github.com/TeWu/1234573/29803f9cf380caddd2b0b1f6a57a4da03cf3ae55

# Request handler
get '/cve' do
  # Quick wash
  target = Sanitize.fragment(params['target'])
  year = Sanitize.fragment(params['year'])

  @names = [get_cve(target, year)]

  erb :result
end

# Deliver status
get '/status' do
  '200'
end

# Default page
get '/' do
    bind = ENV['HOST']
    port = ENV['PORT']
    erb :index, :locals => {:bind => bind, :port => port}
end

# Disallowed methods
FORBIDDEN = 403
FORBIDDEN_DESCRIPTION = 'Disallowed request method.'

post '/' do
  halt FORBIDDEN, FORBIDDEN_DESCRIPTION
end
put '/' do
  halt FORBIDDEN, FORBIDDEN_DESCRIPTION
end
patch '/' do
  halt FORBIDDEN, FORBIDDEN_DESCRIPTION
end
delete '/' do
  halt FORBIDDEN, FORBIDDEN_DESCRIPTION
end
options '/' do
  halt FORBIDDEN, FORBIDDEN_DESCRIPTION
end
link '/' do
  halt FORBIDDEN, FORBIDDEN_DESCRIPTION
end
unlink '/' do
  halt FORBIDDEN, FORBIDDEN_DESCRIPTION
end
