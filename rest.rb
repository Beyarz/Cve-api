# frozen_string_literal: true

# Fallback when importing fails
def import_failure
  puts '[!] Try "bundle install"'
  exit(1)
end

require 'erb'
require 'json'
require 'net/http'

begin
  require 'sinatra'
rescue LoadError
  import_failure
end

begin
  require 'sanitize'
rescue LoadError
  import_failure
end

require_relative 'configuration.rb'
require_relative 'scan.rb'

# Note: https://gist.github.com/TeWu/1234573/29803f9cf380caddd2b0b1f6a57a4da03cf3ae55

# Request handler

get '/cve' do
  # Quick wash
  target = Sanitize.fragment(params['target'])
  year = Sanitize.fragment(params['year'])

  @names = [get_cve(target, year)]

  erb :result
end

# Deliver status
get '/status' do
  '200'
end

# Default page
get '/' do
    erb :index, :locals => {:bind => "localhost", :port => 8000}
end

# Disallowed methods
post '/' do
  halt 403, 'Disallowed request method.'
end
put '/' do
  halt 403, 'Disallowed request method.'
end
patch '/' do
  halt 403, 'Disallowed request method.'
end
delete '/' do
  halt 403, 'Disallowed request method.'
end
options '/' do
  halt 403, 'Disallowed request method.'
end
link '/' do
  halt 403, 'Disallowed request method.'
end
unlink '/' do
  halt 403, 'Disallowed request method.'
end
